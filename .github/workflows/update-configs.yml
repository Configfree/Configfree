name: Update and Replace Configs
on:
  schedule:
    - cron: '*/30 * * * *'  # Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
  workflow_dispatch:        # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  replace-configs:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø®Ø²Ù† Ù‡Ø¯Ù (configfree/Configfree)
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: configfree/Configfree
          path: configfree
          token: ${{ secrets.ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø®Ø²Ù† Ù…Ù†Ø¨Ø¹ (Lightningteam2007/Config)
      - name: Checkout Source Repository
        uses: actions/checkout@v4
        with:
          repository: Lightningteam2007/Config
          path: config-source
          token: ${{ secrets.ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      # Ù…Ø±Ø­Ù„Ù‡ 3: Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
      - name: Replace Configs
        run: |
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„ Ù…Ù†Ø¨Ø¹
          if [ ! -f config-source/processed_configs.txt ]; then
            echo "::error::ÙØ§ÛŒÙ„ processed_configs.txt ÛŒØ§ÙØª Ù†Ø´Ø¯!"
            exit 1
          fi

          # Ø­Ø°Ù ÙØ§ÛŒÙ„ Ù‚Ø¯ÛŒÙ…ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
          rm -f configfree/configs.txt

          # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù‡Ù…Ø§Ù† Ù†Ø§Ù…
          cp config-source/processed_configs.txt configfree/configs.txt

          # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
          LINE_COUNT=$(wc -l < configfree/configs.txt)
          echo "ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: $LINE_COUNT"
          echo "Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§:"
          head -n 5 configfree/configs.txt

      # Ù…Ø±Ø­Ù„Ù‡ 4: ØªÙ†Ø¸ÛŒÙ…Ø§Øª GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Ù…Ø±Ø­Ù„Ù‡ 5: Ø¢Ù¾Ù„ÙˆØ¯ ØªØºÛŒÛŒØ±Ø§Øª
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: configfree
          retention-days: 1

      # Ù…Ø±Ø­Ù„Ù‡ 6: Ø§Ù†ØªØ´Ø§Ø±
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        id: deployment

      # Ù…Ø±Ø­Ù„Ù‡ 7: Ú©Ø§Ù…ÛŒØª ØªØºÛŒÛŒØ±Ø§Øª
      - name: Commit Changes
        run: |
          cd configfree
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          git add configs.txt
          
          if git diff --cached --quiet; then
            echo "Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          else
            git commit -m "ğŸ” Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ - $(date +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main
            git push origin main
            echo "Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´Ø¯Ù†Ø¯"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      # Ù…Ø±Ø­Ù„Ù‡ 8: ØªØ£ÛŒÛŒØ¯ Ø§Ù†ØªØ´Ø§Ø±
      - name: Verify Deployment
        if: always()
        run: |
          if [[ ${{ steps.deployment.outputs.status }} != 'success' ]]; then
            echo "::error::Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!"
            exit 1
          fi
          echo "âœ… Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"
          echo "Ø¢Ø¯Ø±Ø³ Ø³Ø§ÛŒØª: https://configfree.github.io/Configfree/"
