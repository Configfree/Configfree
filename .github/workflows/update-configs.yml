name: Update Configs and Deploy to GitHub Pages
on:
  schedule:
    - cron: '*/30 * * * *'  # Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:  # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø­ÛŒØ· deployment
      name: github-pages
      url: https://configfree.github.io/Configfree/

    steps:
      # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø®Ø²Ù† Ù‡Ø¯Ù
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: configfree/Configfree
          path: configfree
          token: ${{ secrets.ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø®Ø²Ù† Ù…Ù†Ø¨Ø¹
      - name: Checkout Source Repository
        uses: actions/checkout@v4
        with:
          repository: Lightningteam2007/Config
          path: config-source
          token: ${{ secrets.ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      # Ù…Ø±Ø­Ù„Ù‡ 3: Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
      - name: Replace Configs
        run: |
          if [ ! -f config-source/processed_configs.txt ]; then
            echo "::error::ÙØ§ÛŒÙ„ processed_configs.txt ÛŒØ§ÙØª Ù†Ø´Ø¯!"
            exit 1
          fi

          rm -f configfree/configs.txt
          cp config-source/processed_configs.txt configfree/configs.txt

          LINE_COUNT=$(wc -l < configfree/configs.txt)
          echo "ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: $LINE_COUNT"
          echo "Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§:"
          head -n 5 configfree/configs.txt

      # Ù…Ø±Ø­Ù„Ù‡ 4: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Ù…Ø±Ø­Ù„Ù‡ 5: Ø¢Ù¾Ù„ÙˆØ¯ Ø¢Ø±ØªÛŒÙÚ©Øª
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: configfree
          retention-days: 1

      # Ù…Ø±Ø­Ù„Ù‡ 6: Ø§Ø³ØªÙ‚Ø±Ø§Ø±
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        id: deployment

      # Ù…Ø±Ø­Ù„Ù‡ 7: Ú©Ø§Ù…ÛŒØª ØªØºÛŒÛŒØ±Ø§Øª
      - name: Commit Changes
        run: |
          cd configfree
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          if git diff --quiet -- configs.txt; then
            echo "Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
          else
            git add configs.txt
            git commit -m "ğŸ” Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ - $(date +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main
            git push origin main
            echo "Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´Ø¯Ù†Ø¯"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
